# MCP 架构图解

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      AI 应用 (Claude Desktop)                │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              MCP 客户端 (Client)                       │  │
│  │  - 发现可用工具                                         │  │
│  │  - 调用工具                                             │  │
│  │  - 处理响应                                             │  │
│  └───────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ MCP 协议 (JSON-RPC)
                       │ 通过 stdio/HTTP
                       │
┌──────────────────────┴──────────────────────────────────────┐
│                   MCP 服务器 (Server)                        │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                      工具 (Tools)                      │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │  │
│  │  │   add   │  │subtract │  │multiply │  │ divide  │  │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    资源 (Resources)                    │  │
│  │  - 文件系统访问                                         │  │
│  │  - 数据库查询                                           │  │
│  │  - API 调用                                             │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   提示词 (Prompts)                     │  │
│  │  - 预定义模板                                           │  │
│  │  - 上下文注入                                           │  │
│  └───────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────┘
```

## 通信流程

```
1. 初始化连接
   Claude Desktop → MCP Server
   [initialize 请求]

2. 发现能力
   Claude Desktop → MCP Server
   [list_tools/list_resources/list_prompts 请求]
   
   Claude Desktop ← MCP Server
   [返回可用工具列表]

3. 工具调用
   用户: "请帮我计算 15 + 27"
   
   Claude Desktop → MCP Server
   [call_tool: add, arguments: {a: 15, b: 27}]
   
   Claude Desktop ← MCP Server
   [返回: "计算结果: 15 + 27 = 42"]
   
   显示给用户: "计算结果是 42"
```

## 本示例的具体实现

```
┌──────────────────────────────────────────────────┐
│          simple-calculator-mcp                   │
│                                                   │
│  工具列表:                                        │
│  ┌────────────────────────────────────────────┐  │
│  │ add(a, b)        → 返回 a + b              │  │
│  │ subtract(a, b)   → 返回 a - b              │  │
│  │ multiply(a, b)   → 返回 a × b              │  │
│  │ divide(a, b)     → 返回 a ÷ b (b≠0)        │  │
│  └────────────────────────────────────────────┘  │
│                                                   │
│  数据流:                                          │
│  ┌────────────────────────────────────────────┐  │
│  │ 1. 接收请求参数 {a, b}                     │  │
│  │ 2. 验证参数类型                             │  │
│  │ 3. 执行计算                                 │  │
│  │ 4. 格式化结果                               │  │
│  │ 5. 返回文本响应                             │  │
│  └────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
```

## MCP 协议核心概念

### 1. 服务器能力 (Server Capabilities)

```javascript
{
  capabilities: {
    tools: {},        // 支持工具调用
    resources: {},    // 支持资源访问
    prompts: {}       // 支持提示词模板
  }
}
```

### 2. 工具定义 (Tool Definition)

```javascript
{
  name: "add",
  description: "将两个数字相加",
  inputSchema: {
    type: "object",
    properties: {
      a: { type: "number", description: "第一个数字" },
      b: { type: "number", description: "第二个数字" }
    },
    required: ["a", "b"]
  }
}
```

### 3. 工具调用 (Tool Call)

```javascript
// 请求
{
  method: "tools/call",
  params: {
    name: "add",
    arguments: { a: 15, b: 27 }
  }
}

// 响应
{
  content: [
    { type: "text", text: "计算结果: 15 + 27 = 42" }
  ]
}
```

## 扩展示例

### 添加新工具

```javascript
// 1. 在工具列表中添加定义
{
  name: "square_root",
  description: "计算平方根",
  inputSchema: {
    type: "object",
    properties: {
      x: { type: "number", description: "要计算平方根的数字" }
    },
    required: ["x"]
  }
}

// 2. 在调用处理器中添加实现
case "square_root":
  if (args.x < 0) {
    throw new Error("不能计算负数的平方根");
  }
  result = Math.sqrt(args.x);
  break;
```

## 安全考虑

```
┌─────────────────────────────────────────────┐
│           安全边界                          │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │     MCP 服务器                        │ │
│  │  - 输入验证                           │ │
│  │  - 类型检查                           │ │
│  │  - 错误处理                           │ │
│  │  - 权限控制                           │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  隔离的执行环境                             │
│  - 不能访问任意文件系统                     │
│  - 不能执行任意命令                         │
│  - 仅提供明确定义的功能                     │
└─────────────────────────────────────────────┘
```
